<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>PlayNFT - The Playground for your NFTs</title>
    <meta content="" name="description" />

    <meta content="nft" name="keywords" />

    <!-- Favicons -->
    <link href="../assets/img/favicon.png" rel="icon" />
    <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
        rel="stylesheet" />

    <!-- Vendor CSS Files -->
    <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="../assets/vendor/aos/aos.css" rel="stylesheet" />
    <link href="../assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
    <link href="../assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <link href="../assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="../assets/css/style.css" rel="stylesheet" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>
    <script src="https://kit.fontawesome.com/0a0492e97d.js" crossorigin="anonymous"></script>
    <script
        src="https://www.paypal.com/sdk/js?client-id=Afublr47iUx9od__o9lROJup9U0wx74gtOgqlGi-xPG8hGRUggDp1497DSQTMaAN9hP5FspYXTg9bZu0"></script>

    <script src="https://cdn.tiny.cloud/1/doicvbneaya0gerwmrc6gn0ei4uw3vsk4znmslowgfwri44v/tinymce/5/tinymce.min.js"
        referrerpolicy="origin"></script>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/moralis/dist/moralis.js"></script>

    <script>
        tinymce.init({
            selector: 'textarea',
            menubar: false
        });
    </script>
</head>

<body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top">
        <div class="container-fluid container-xl d-flex align-items-center justify-content-between">
            <a href="../index.html" class="logo d-flex align-items-center">
                <img src="../assets/img/logo.png" alt="PlayNFT" />
            </a>

            <nav id="navbar" class="navbar">
                <ul>
                    <li><a class="nav-link scrollto active" href="../index.html">Home</a></li>
                </ul>
                <i class="bi bi-list mobile-nav-toggle"></i>
            </nav>
            <!-- .navbar -->
        </div>
    </header>
    <!-- End Header -->

    <main id="main">
        <!-- ======= Streamers Section ======= -->
        <section id="section-streamers" class="gamers">
            <div class="container">
                <header class="section-header">
                    <h2>Twitch Tokens</h2>
                    <p>Claim your NFTs</p>
                </header>

                <div class="wizard">
                    <div class="wizard-inner">
                        <div class="connecting-line"></div>
                        <ul class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="nav-item active">
                                <a title="1. Twitch Login" class="nav-link" id="nav-twitch-login" role="tab"
                                    data-bs-toggle="tab" aria-controls="twitch-login" href="#list-twitch-login">
                                    <span class="round-tab">
                                        <i class="fas fa-user-tie" style="font-size: 3.7vh"></i>
                                    </span>
                                </a>
                            </li>
                            <li role="presentation" class="nav-item disabled">
                                <a title="2. Claim NFTs" class="nav-link" id="nav-twitch-nfts" role="tab"
                                    data-bs-toggle="tab" aria-controls="twitch-nfts" href="#list-twitch-nfts">
                                    <span class="round-tab"><i class="fas fa-sd-card"
                                            style="font-size: 3.7vh"></i></span>
                                </a>
                            </li>
                            <li role="presentation" class="nav-item disabled">
                                <a title="3. Connect Wallet" class="nav-link" id="nav-twitch-wallet" role="tab"
                                    data-bs-toggle="tab" aria-controls="twitch-wallet" href="#list-twitch-wallet">
                                    <span class="round-tab"><i class="fas fa-wallet"
                                            style="font-size: 3.7vh"></i></span>
                                </a>
                            </li>
                            <li role="presentation" class="nav-item disabled">
                                <a title="4. Blockchain Confirmations" class="nav-link" id="nav-twitch-review"
                                    role="tab" data-bs-toggle="tab" aria-controls="twitch-review"
                                    href="#list-twitch-review">
                                    <span class="round-tab"><i class="fas fa-link" style="font-size: 3.7vh"></i></span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="row spacer">&nbsp;</div>

                <div class="row">
                    <div class="col-12">
                        <div class="tab-content" id="nav-tabContent">
                            <div class="tab-pane fade show active" id="list-twitch-login" role="tabpanel"
                                aria-labelledby="nav-twitch-login">
                                <div class="col-lg-12">
                                    <h4>Streamer Login</h4>

                                    <div class="row gy-4 text-center">
                                        <div class="pricing">
                                            <div class="price"></div>

                                            <br /><a href="#" class="btn-buy" id="login-twitch">Authenticate Twitch
                                                Account</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="list-twitch-nfts" role="tabpanel"
                                aria-labelledby="nav-twitch-nfts">
                                <div class="col-md-12">
                                    <div class="panel panel-primary" id="twitch-nfts-panel">
                                        <div class="panel-heading">
                                            <h4>Claim NFTs</h4>
                                        </div>
                                        <div style="text-align: end; padding-bottom: 20px;">

                                        </div>
                                        <div class="panel-body">
                                            <ul class="list-group" id="twitch-nfts">

                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="list-twitch-wallet" role="tabpanel"
                                aria-labelledby="nav-twitch-wallet">
                                <div class="col-lg-12">
                                    <h4>Input your Wallet address</h4>
                                    <form id="twitch-scan-form" action="#" method="post">
                                        <div class="row gy-4">
                                            <div class="col-md-12 text-center">
                                                <input type="text" name="walletAddress" id="twitch-walletAddress"
                                                    class="form-control" placeholder="Ethereum Wallet Address"
                                                    required />
                                            </div>

                                            <div class="col-md-12 text-center">
                                                <button id="twitch-scan-wallet" class="btn-read-more" type="submit">
                                                    Mint NFT!
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="list-twitch-review" role="tabpanel"
                                aria-labelledby="nav-twitch-review">
                                <div class="col-md-12">
                                    <div class="panel panel-primary" id="twitch-review-panel">
                                        <div class="panel-heading">
                                            <h4>Blockchain Confirmation</h4>
                                            <p class="section-header"></p>
                                        </div>
                                        <div class="panel-body">
                                            <div class="flex-shrink-0 text-center">
                                                <p class="game-icon">
                                                    <a href="https://dashboard.twitch.tv/extensions/3v4y6bwztvpyxfeoxq5ik79iosx3km-0.0.1"
                                                        target="_blank">
                                                        <img src="assets/img/extensions.png" class="img-fluid"
                                                            alt="Twitch Extensions" /><br>
                                                        <button id="streamers-extension-btn" type="button"
                                                            class="btn btn-primary">
                                                            <span class="fa fa-external-link"></span> Install Extension
                                                        </button>
                                                    </a>
                                                </p>

                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- ======= End Streamers Section ======= -->
    </main>

    <!-- Vendor JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js"
        integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT"
        crossorigin="anonymous"></script>
    <script src="../assets/vendor/aos/aos.js"></script>
    <script src="../assets/vendor/php-email-form/validate.js"></script>
    <script src="../assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="../assets/vendor/purecounter/purecounter.js"></script>
    <script src="../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="../assets/vendor/glightbox/js/glightbox.min.js"></script>

    <!-- Template Main JS File -->
    <script src="../assets/js/main.js"></script>

    <script id="twitch-nfts-template" type="text/x-jquery-tmpl">
        <li id="streamers_nft_${id}" class="list-group-item d-flex list-group-item-action streamers-nft-item">
          <div class="flex-shrink-0 game-icon">
            <img
              src="https://playnft.s3.amazonaws.com/nfts/${streamerId}/${id}/icon.png"
              class="img-fluid"
              alt="${name}"
            />
          </div>
          <div class="flex-grow-1 ms-3">
            <strong>${name}</strong>
            <p>Streamer: ${streamer}<br/>
            Date Acquired: ${date}</p>
            <div class="actions">
              
              <a href="#" id="twitch-nfts-select" class="btn-details-select" data-id="${transactionId}" data-streamerid="${streamerId}" >Claim</a>
            </div>
          </div>
        </li>
      </script>
</body>
<script>
    var streamerID = "";
    var transactionID = "";
    var walletID = "";
    var buyerID = "";

    $(document).ready(function () {

        var hash = window.location.hash.substring(1);
        var params = {}
        hash.split('&').map(hk => {
            let temp = hk.split('=');
            params[temp[0]] = temp[1]
        });

        console.log(params)
        if (params.access_token && params.token_type && params.state && params.id_token) {
            var clientID = "bugcm9v8dm9e2d4wp7u9l3hsnd5plo"
            let state = window.btoa(encodeURIComponent(escape(new Date().toDateString())));
            if (params.state == state) {

                $.ajax({
                    url: 'https://id.twitch.tv/oauth2/userinfo',
                    type: 'GET',
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + params.access_token);
                    },
                    data: {},
                    success: function (data) {
                        console.info(data);

                        if (data.aud != clientID) return;
                        if (data.email_verified == false) {
                            alert("Twitch Email must be verified!");
                            return;
                        }

                        buyerID = data.sub
                        let formData = { streamer_id: buyerID, mode: "buyer" };

                        $.ajax({
                            url:
                                "https://api.playnft.io/getnfts",
                            type: "POST",
                            crossDomain: true,
                            data: JSON.stringify(formData),
                            dataType: "json",
                            contentType: "application/json",
                            success: function (data) {
                                console.info(data);
                                let response = jQuery.parseJSON(data);

                                $("#twitch-nfts").empty();

                                response.forEach(function (item) {
                                    var date = new Date(item.date)
                                    var dateString = date.toLocaleString('en-US', {
                                        day: 'numeric', // numeric, 2-digit
                                        year: 'numeric', // numeric, 2-digit
                                        month: 'long', // numeric, 2-digit, long, short, narrow
                                        hour: 'numeric', // numeric, 2-digit
                                        minute: 'numeric', // numeric, 2-digit
                                        second: 'numeric', // numeric, 2-digit
                                    })
                                    let game_content = { id: item.id, transactionId: item.transactionId, name: item.name, date: dateString, streamer: item.streamer, streamerId: item.streamerId };
                                    $("#twitch-nfts-template")
                                        .tmpl(game_content)
                                        .appendTo("#twitch-nfts");
                                });

                                openTab("#nav-twitch-nfts");
                            },
                        });


                    },
                    error: function (error) {
                        console.info(error);
                    },
                });
            }
        }
    });

    $(document).on("click", "#login-twitch", function () {
        let clientID = "bugcm9v8dm9e2d4wp7u9l3hsnd5plo"
        let redirectSite = location.protocol + "//" + location.host + "/twitch"
        let state = window.btoa(encodeURIComponent(escape(new Date().toDateString())));


        location = 'https://id.twitch.tv/oauth2/authorize?response_type=token+id_token&client_id=' + clientID + '&redirect_uri=' + redirectSite + '&scope=openid%20user:read:email&state=' + state + '&claims={"id_token":{"email":null,"email_verified":null},"userinfo":{"email":null,"email_verified":null,"picture":null, "preferred_username":null}}';

    });

    $(document).on("click", "#twitch-nfts-select", function () {

        transactionID = $(this).data('id');
        streamerID = $(this).data('streamerid');

        openTab("#nav-twitch-wallet");
    });

    $("#twitch-scan-form").on("submit", function (e) {
        e.preventDefault();

        walletID = $('#twitch-walletAddress').val()
        let formData = { transactionId: transactionID, streamerId: streamerID, wallet: walletID, buyerId: buyerID };

        $.ajax({
            url:
                "https://api.playnft.io/mintnft",
            type: "POST",
            crossDomain: true,
            data: JSON.stringify(formData),
            dataType: "json",
            contentType: "application/json",
            success: function (data) {
                console.info(data);
                let response = jQuery.parseJSON(data);

                openTab("#nav-twitch-review");
            },
        });
    });


    function openTab(tabId) {
        let active = $(".wizard .nav-tabs li.active");
        console.log(active)
        active.addClass("completed");
        active.removeClass("active");
        let next = active.next();

        next.addClass("active");
        next.removeClass("disabled");

        var nextTab = document.querySelector(tabId);
        var tab = new bootstrap.Tab(nextTab);
        tab.show();
    }
</script>

</html>